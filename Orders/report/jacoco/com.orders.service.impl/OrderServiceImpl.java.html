<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Orders</a> &gt; <a href="index.source.html" class="el_package">com.orders.service.impl</a> &gt; <span class="el_source">OrderServiceImpl.java</span></div><h1>OrderServiceImpl.java</h1><pre class="source lang-java linenums">package com.orders.service.impl;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.orders.constants.OrderConstants;
import com.orders.conversion.DtoConversion;
import com.orders.dto.OrderInDto;
import com.orders.dto.AddressOutDto;
import com.orders.dto.FoodItemOutDto;
import com.orders.dto.MessageOutDto;
import com.orders.dto.OrderOutDto;
import com.orders.dto.UserOutDto;
import com.orders.entities.Cart;
import com.orders.entities.Order;
import com.orders.exception.AddressNotFoundException;
import com.orders.exception.CartNotFoundException;
import com.orders.exception.CustomerNotFoundException;
import com.orders.exception.InsufficientBalanceException;
import com.orders.exception.OrderNotFoundException;
import com.orders.exception.OrderUpdateException;
import com.orders.repositories.OrderRepository;
import com.orders.service.AddressFeignClient;
import com.orders.service.CartService;
import com.orders.service.OrderService;
import com.orders.service.RestaurantFeignClient;
import com.orders.service.UserFeignClient;
import com.orders.utils.OrderStatus;
import com.orders.utils.UserRole;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Service
<span class="fc" id="L37">public class OrderServiceImpl implements OrderService {</span>

  @Autowired
  private RestaurantFeignClient restaurantClient;

  @Autowired
  private OrderRepository orderRepository;

  @Autowired
  private CartService cartService;

  @Autowired
  private UserFeignClient userClient;

  @Autowired
  private AddressFeignClient addressClient;

  @Override
  public MessageOutDto placeOrder(OrderInDto orderInDto) {
<span class="fc" id="L56">    UserOutDto user = getUser(orderInDto.getUserId());</span>
<span class="fc" id="L57">    validateUserRole(user);</span>
<span class="fc" id="L58">    List&lt;AddressOutDto&gt; addresses = getAddresses(orderInDto.getUserId());</span>
<span class="fc" id="L59">    validateAddress(orderInDto.getDeliveryAddressId(), addresses);</span>
<span class="fc" id="L60">    List&lt;Cart&gt; cartItems = getCartItems(orderInDto);</span>
<span class="fc" id="L61">    validateCartItems(cartItems, orderInDto.getCartItems());</span>

<span class="fc" id="L63">    BigDecimal totalPrice = calculateTotalPrice(orderInDto.getCartItems());</span>
<span class="fc" id="L64">    validateWalletBalance(user, totalPrice);</span>

<span class="fc" id="L66">    updateWalletBalance(user, totalPrice);</span>
<span class="fc" id="L67">    Order order = createOrder(orderInDto, totalPrice, cartItems);</span>

<span class="fc" id="L69">    orderRepository.save(order);</span>
<span class="fc" id="L70">    cartService.clearCartAfterOrderPlaced(orderInDto.getUserId(), orderInDto.getRestaurantId());</span>

<span class="fc" id="L72">    return new MessageOutDto(OrderConstants.ORDER_PLACED_SUCCESSFULLY);</span>
  }

  private UserOutDto getUser(Integer userId) {
<span class="fc" id="L76">    return userClient.getUserById(userId);</span>
  }

  private void validateUserRole(UserOutDto user) {
<span class="fc bfc" id="L80" title="All 2 branches covered.">    if (user.getUserRole() != UserRole.CUSTOMER) {</span>
<span class="fc" id="L81">      throw new CustomerNotFoundException(OrderConstants.CUSTOMER_NOT_FOUND);</span>
    }
<span class="fc" id="L83">  }</span>

  private List&lt;AddressOutDto&gt; getAddresses(Integer userId) {
<span class="fc" id="L86">    return addressClient.getAddressesByUserId(userId);</span>
  }

  private void validateAddress(Integer deliveryAddressId, List&lt;AddressOutDto&gt; addresses) {
<span class="fc" id="L90">    boolean validAddress = addresses.stream()</span>
<span class="fc" id="L91">      .anyMatch(address -&gt; address.getId().equals(deliveryAddressId));</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">    if (!validAddress) {</span>
<span class="fc" id="L93">      throw new AddressNotFoundException(OrderConstants.ADDRESS_NOT_FOUND);</span>
    }
<span class="fc" id="L95">  }</span>

  private List&lt;Cart&gt; getCartItems(OrderInDto orderInDto) {
<span class="fc" id="L98">    List&lt;Cart&gt; cartItems = cartService.getCartItemsByUserIdAndRestaurantId(orderInDto.getUserId(), orderInDto.getRestaurantId());</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">    if (cartItems.isEmpty()) {</span>
<span class="fc" id="L100">      throw new CartNotFoundException(&quot;No items found in the cart for user &quot; + orderInDto.getUserId() +</span>
<span class="fc" id="L101">        &quot; and restaurant &quot; + orderInDto.getRestaurantId());</span>
    }
<span class="fc" id="L103">    return cartItems;</span>
  }

  private void validateCartItems(List&lt;Cart&gt; cartItems, List&lt;Cart&gt; cartItemsDto) {
<span class="fc" id="L107">    List&lt;Cart&gt; invalidCartItems = cartItemsDto.stream()</span>
<span class="pc" id="L108">      .filter(cartItemDto -&gt; cartItems.stream()</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">        .noneMatch(cartItem -&gt; cartItem.getFoodItemId().equals(cartItemDto.getFoodItemId())</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">          &amp;&amp; cartItem.getQuantity().equals(cartItemDto.getQuantity())</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">          &amp;&amp; cartItem.getPrice().compareTo(cartItemDto.getPrice()) == 0))</span>
<span class="fc" id="L112">      .collect(Collectors.toList());</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">    if (!invalidCartItems.isEmpty()) {</span>
<span class="nc" id="L114">      throw new RuntimeException(&quot;Some items are not valid in the cart: &quot; + invalidCartItems.stream()</span>
<span class="nc" id="L115">        .map(dto -&gt; String.format(&quot;foodItemId=%d, quantity=%d, price=%s&quot;, dto.getFoodItemId(), dto.getQuantity(), dto.getPrice()))</span>
<span class="nc" id="L116">        .collect(Collectors.joining(&quot;, &quot;)));</span>
    }
<span class="fc" id="L118">  }</span>

  private BigDecimal calculateTotalPrice(List&lt;Cart&gt; cartItems) {
<span class="fc" id="L121">    return cartItems.stream()</span>
<span class="pc" id="L122">      .map(item -&gt; item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity())))</span>
<span class="fc" id="L123">      .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
  }

  private void validateWalletBalance(UserOutDto user, BigDecimal totalPrice) {
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">    if (user.getWalletBalance().compareTo(totalPrice) &lt; 0) {</span>
<span class="nc" id="L128">      throw new InsufficientBalanceException(&quot;Insufficient balance in wallet to place the order.&quot;);</span>
    }
<span class="fc" id="L130">  }</span>

  private void updateWalletBalance(UserOutDto user, BigDecimal totalPrice) {
<span class="fc" id="L133">    userClient.updateWalletBalance(user.getId(), totalPrice.negate());</span>
<span class="fc" id="L134">  }</span>

  private Order createOrder(OrderInDto orderInDto, BigDecimal totalPrice, List&lt;Cart&gt; validCartItems) {
<span class="fc" id="L137">    Order order = DtoConversion.convertOrderInDtoToOrder(orderInDto);</span>
<span class="fc" id="L138">    order.setRestaurantId(orderInDto.getRestaurantId());</span>
<span class="fc" id="L139">    order.setOrderStatus(OrderStatus.PLACED);</span>
<span class="fc" id="L140">    order.setOrderTime(LocalDateTime.now());</span>
    try {
<span class="fc" id="L142">      order.setCartItemsFromList(validCartItems);</span>
<span class="nc" id="L143">    } catch (JsonProcessingException e) {</span>
<span class="nc" id="L144">      throw new RuntimeException(&quot;Failed to process cart items&quot;, e);</span>
<span class="fc" id="L145">    }</span>
<span class="fc" id="L146">    order.setTotalPrice(totalPrice);</span>
<span class="fc" id="L147">    return order;</span>
  }

  @Override
  public MessageOutDto cancelOrder(Integer orderId) {
<span class="fc" id="L152">    Order order = orderRepository.findById(orderId)</span>
<span class="pc" id="L153">      .orElseThrow(() -&gt; new OrderNotFoundException(&quot;Order not found for ID: &quot; + orderId));</span>

<span class="fc bfc" id="L155" title="All 2 branches covered.">    if (order.getOrderTime().plusSeconds(30).isBefore(LocalDateTime.now())) {</span>
<span class="fc" id="L156">      throw new OrderUpdateException(&quot;Order cannot be cancelled after 30 seconds.&quot;);</span>
    }

<span class="fc" id="L159">    userClient.updateWalletBalance(order.getUserId(), order.getTotalPrice());</span>

<span class="fc" id="L161">    order.setOrderStatus(OrderStatus.CANCELLED);</span>
<span class="fc" id="L162">    orderRepository.save(order);</span>
<span class="fc" id="L163">    return new MessageOutDto(OrderConstants.ORDER_CANCELLED_SUCCESSFULLY);</span>
  }

  @Override
  public List&lt;OrderOutDto&gt; getOrdersByUserId(Integer userId) {
<span class="fc" id="L168">    UserOutDto user = getUser(userId);</span>
<span class="fc" id="L169">    validateUserRole(user);</span>
<span class="fc" id="L170">    List&lt;Order&gt; orders = orderRepository.findByUserId(userId);</span>
<span class="fc" id="L171">    return orders.stream()</span>
<span class="fc" id="L172">      .map(DtoConversion::convertOrderToOrderOutDto)</span>
<span class="fc" id="L173">      .collect(Collectors.toList());</span>
  }

  @Override
  public List&lt;OrderOutDto&gt; getOrdersByRestaurantId(Integer restaurantId) {
<span class="nc" id="L178">    FoodItemOutDto restaurant = restaurantClient.getRestaurantById(restaurantId);</span>

<span class="nc" id="L180">    List&lt;Order&gt; orders = orderRepository.findByRestaurantId(restaurantId);</span>
<span class="nc" id="L181">    return orders.stream()</span>
<span class="nc" id="L182">      .map(DtoConversion::convertOrderToOrderOutDto)</span>
<span class="nc" id="L183">      .collect(Collectors.toList());</span>
  }

  @Override
  public MessageOutDto markOrderAsCompleted(Integer orderId, Integer userId) {
<span class="fc" id="L188">    Order order = orderRepository.findById(orderId)</span>
<span class="fc" id="L189">      .orElseThrow(() -&gt; new OrderNotFoundException(&quot;Order not found for ID: &quot; + orderId));</span>

<span class="fc" id="L191">    UserOutDto user = getUser(userId);</span>

<span class="fc bfc" id="L193" title="All 2 branches covered.">    if (user.getUserRole() != UserRole.RESTAURANT_OWNER) {</span>
<span class="fc" id="L194">      throw new OrderUpdateException(&quot;Only a restaurant owner can complete this order.&quot;);</span>
    }
<span class="fc" id="L196">    order.setOrderStatus(OrderStatus.COMPLETED);</span>
<span class="fc" id="L197">    orderRepository.save(order);</span>

<span class="fc" id="L199">    new MessageOutDto(OrderConstants.ORDER_COMPLETED_SUCCESSFULLY);</span>
<span class="fc" id="L200">    return null;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>